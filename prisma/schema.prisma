generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum SubscriptionProvider {
  PAYPAL
  BANK_TRANSFER
}

enum SubscriptionStatus {
  PENDING
  ACTIVE
  EXPIRED
  CANCELED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum VehicleStatus {
  AVAILABLE
  RESERVED
  SOLD
  ARCHIVED
}

enum MediaKind {
  IMAGE
  VIDEO
}

enum LeadStatus {
  NEW
  IN_PROGRESS
  WON
  LOST
}

enum ActivityType {
  CALL
  WHATSAPP
  EMAIL
  MEETING
  NOTE
  SYSTEM
}



model Store {
  id          String   @id @default(uuid()) @db.Uuid
  name        String
  slug        String   @unique
  logoUrl     String?  @map("logo_url")
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  domains      StoreDomain[]
  apiKeys      StoreApiKey[]
  branches     Branch[]
  memberships  UserRole[]

  vehicles     Vehicle[]
  customers    Customer[]
  leads        Lead[]
  activities   Activity[]
  sales        VehicleSale[]

  subscriptions StoreSubscription[]

  vehicleReservations VehicleReservation[]
  leadPreferences     LeadPreference[]

  auditLogs    AuditLog[]
  consignors   Consignor[]
  permissionSets PermissionSet[]

  @@index([createdAt])
}

model StoreDomain {
  id        String   @id @default(uuid()) @db.Uuid
  storeId   String   @db.Uuid
  domain    String   @unique
  isPrimary Boolean  @default(false)
  createdAt DateTime @default(now())

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([storeId])
}

model StoreApiKey {
  id          String   @id @default(uuid()) @db.Uuid
  storeId     String   @db.Uuid
  name        String
  keyHash     String   @map("key_hash")
  lastUsedAt  DateTime? @map("last_used_at")
  createdAt   DateTime @default(now())

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([storeId])
  @@index([storeId, createdAt])
}

model Branch {
  id        String   @id @default(uuid()) @db.Uuid
  storeId   String   @db.Uuid
  name      String
  address   String?
  isPrimary Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  store    Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  vehicles Vehicle[]

  @@index([storeId])
  @@index([storeId, isPrimary])
}

model User {
  id           String   @id @default(uuid()) @db.Uuid
  email        String   @unique
  passwordHash String   @map("password_hash")
  fullName     String?  @map("full_name")
  // SuperAdmin es global (no depende de store)
  isSuperAdmin Boolean  @default(false) @map("is_super_admin")
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  memberships   UserRole[]
  refreshTokens RefreshToken[]
  resetToken          String?   @map("reset_token")
  resetTokenExpiresAt DateTime? @map("reset_token_expires_at")

  createdVehicles  Vehicle[]              @relation("VehicleCreatedBy")
  changedStatuses  VehicleStatusHistory[] @relation("VehicleStatusChangedBy")
  reservedVehicles VehicleReservation[]   @relation("VehicleReservedBy")
  activities       Activity[]             @relation("ActivityCreatedBy")
  soldSales        VehicleSale[]          @relation("VehicleSoldBy")

  assignedLeads Lead[] @relation("LeadAssignedTo")

  approvedSubscriptions StoreSubscription[] @relation("SubscriptionApprovedBy")

  auditLogs AuditLog[] @relation("AuditActor")

  @@index([createdAt])
}

model UserRole {
  id      String @id @default(uuid()) @db.Uuid
  userId  String @db.Uuid
  storeId String @db.Uuid
  permissions Json?
  permissionSetId String? @db.Uuid @map("permission_set_id")

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
  permissionSet PermissionSet? @relation(fields: [permissionSetId], references: [id], onDelete: SetNull)

  @@unique([userId, storeId])
  @@index([storeId, userId])
}

model RefreshToken {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @db.Uuid
  tokenHash String   @map("token_hash")
  revokedAt DateTime? @map("revoked_at")
  expiresAt DateTime  @map("expires_at")
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model Brand {
  id        String   @id @default(uuid()) @db.Uuid
  name      String   @unique
  createdAt DateTime @default(now())

  models   Model[]
  vehicles Vehicle[]

  leadPreferences LeadPreference[] @relation("LeadPreferenceDesiredBrand")

  @@index([name])
}

model Model {
  id        String   @id @default(uuid()) @db.Uuid
  brandId   String   @db.Uuid
  name      String
  createdAt DateTime @default(now())

  brand    Brand    @relation(fields: [brandId], references: [id], onDelete: Cascade)
  vehicles Vehicle[]

  leadPreferences LeadPreference[] @relation("LeadPreferenceDesiredModel")

  @@unique([brandId, name])
  @@index([brandId])
}

model Vehicle {
  id          String        @id @default(uuid()) @db.Uuid
  storeId     String        @db.Uuid
  branchId    String        @db.Uuid
  publicId    String        @map("public_id")
  status      VehicleStatus @default(AVAILABLE)
  isPublished Boolean       @default(false) @map("is_published")

  brandId     String @db.Uuid
  modelId     String @db.Uuid
  vehicleTypeId String? @db.Uuid @map("vehicle_type_id")

  title       String?
  description String?
  year        Int?
  price       Decimal? @db.Decimal(12, 2)
  mileage     Int?
  vin         String?
  stockNumber String? @map("stock_number")
  color       String?
  transmission String?
  engineSize   Float?   @map("engine_size")
  fuelType     String? @map("fuel_type")

  soldAt      DateTime? @map("sold_at")
  soldPrice   Decimal?  @db.Decimal(12, 2) @map("sold_price")

  consignorId     String? @db.Uuid @map("consignor_id")
  createdByUserId String? @db.Uuid @map("created_by_user_id")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  store   Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)
  branch  Branch @relation(fields: [branchId], references: [id], onDelete: Restrict)
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Restrict)
  model   Model  @relation(fields: [modelId], references: [id], onDelete: Restrict)
  vehicleType VehicleType? @relation(fields: [vehicleTypeId], references: [id], onDelete: SetNull)

  consignor Consignor? @relation(fields: [consignorId], references: [id], onDelete: SetNull)
  createdBy User? @relation("VehicleCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  media         VehicleMedia[]
  statusHistory VehicleStatusHistory[]
  reservation   VehicleReservation?
  sale          VehicleSale?

  activities Activity[]

  @@unique([storeId, publicId])
  @@index([storeId, branchId])
  @@index([storeId, isPublished])
  @@index([storeId, status])
  @@index([brandId])
  @@index([modelId])
  @@index([storeId, createdAt])
  @@unique([storeId, vin], map: "vehicle_store_vin_unique")
}

model VehicleMedia {
  id        String    @id @default(uuid()) @db.Uuid
  vehicleId String    @db.Uuid
  kind      MediaKind @default(IMAGE)

  fileKey   String    @map("file_key")
  url       String
  position  Int       @default(0)
  isCover   Boolean   @default(false) @map("is_cover")

  createdAt DateTime @default(now())

  vehicle Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([vehicleId])
  @@index([vehicleId, position])
}

model VehicleStatusHistory {
  id         String        @id @default(uuid()) @db.Uuid
  vehicleId  String        @db.Uuid
  fromStatus VehicleStatus @map("from_status")
  toStatus   VehicleStatus @map("to_status")
  changedByUserId String?  @db.Uuid @map("changed_by_user_id")
  changedAt  DateTime      @default(now()) @map("changed_at")

  vehicle   Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  changedBy User?   @relation("VehicleStatusChangedBy", fields: [changedByUserId], references: [id], onDelete: SetNull)

  @@index([vehicleId])
  @@index([changedAt])
}

model VehicleReservation {
  id        String   @id @default(uuid()) @db.Uuid
  storeId   String   @db.Uuid
  vehicleId String   @unique @db.Uuid

  reservedByUserId String? @db.Uuid @map("reserved_by_user_id")
  customerId String? @db.Uuid @map("customer_id")
  leadId     String? @db.Uuid @map("lead_id")

  reservedAt DateTime @default(now()) @map("reserved_at")
  expiresAt  DateTime? @map("expires_at")
  notes      String?

  store     Store   @relation(fields: [storeId], references: [id], onDelete: Cascade)
  vehicle   Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  reservedBy User?  @relation("VehicleReservedBy", fields: [reservedByUserId], references: [id], onDelete: SetNull)

  customer Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)
  lead     Lead?     @relation(fields: [leadId], references: [id], onDelete: SetNull)

  @@index([storeId])
  @@index([storeId, reservedAt])
}

model Customer {
  id         String   @id @default(uuid()) @db.Uuid
  storeId    String   @db.Uuid
  fullName   String   @map("full_name")
  phone      String?
  email      String?
  documentId String?  @map("document_id")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  leads      Lead[]
  sales      VehicleSale[]
  activities Activity[]

  reservations VehicleReservation[]

  @@index([storeId])
  @@index([storeId, createdAt])
  @@unique([storeId, phone], map: "customer_store_phone_unique")
  @@unique([storeId, email], map: "customer_store_email_unique")
}

model Lead {
  id        String    @id @default(uuid()) @db.Uuid
  storeId   String    @db.Uuid
  status    LeadStatus @default(NEW)
  source    String?
  fullName  String?   @map("full_name")
  phone     String?
  email     String?

  assignedToUserId String? @db.Uuid @map("assigned_to_user_id")
  customerId       String? @db.Uuid @map("customer_id")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  assignedTo User? @relation("LeadAssignedTo", fields: [assignedToUserId], references: [id], onDelete: SetNull)
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  preference LeadPreference?
  activities Activity[]
  sales      VehicleSale[]

  reservations VehicleReservation[]

  @@index([storeId])
  @@index([storeId, status])
  @@index([storeId, assignedToUserId])
  @@index([storeId, createdAt])
}

model VehicleType {
  id        String   @id @default(uuid()) @db.Uuid
  name      String   @unique
  createdAt DateTime @default(now())

  vehicles Vehicle[]
  leadPreferences LeadPreference[] @relation("LeadPreferenceVehicleType")

  @@index([name])
}

model LeadPreference {
  id        String   @id @default(uuid()) @db.Uuid
  storeId   String   @db.Uuid
  leadId    String   @unique @db.Uuid

  minPrice  Decimal? @db.Decimal(12, 2) @map("min_price")
  maxPrice  Decimal? @db.Decimal(12, 2) @map("max_price")
  yearFrom  Int?     @map("year_from")
  yearTo    Int?     @map("year_to")

  desiredBrandId String? @db.Uuid @map("desired_brand_id")
  desiredModelId String? @db.Uuid @map("desired_model_id")
  vehicleTypeId  String? @db.Uuid @map("vehicle_type_id")

  notes     String?

  lead  Lead  @relation(fields: [leadId], references: [id], onDelete: Cascade)
  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  desiredBrand Brand?       @relation("LeadPreferenceDesiredBrand", fields: [desiredBrandId], references: [id], onDelete: SetNull)
  desiredModel Model?       @relation("LeadPreferenceDesiredModel", fields: [desiredModelId], references: [id], onDelete: SetNull)
  vehicleType  VehicleType? @relation("LeadPreferenceVehicleType", fields: [vehicleTypeId], references: [id], onDelete: SetNull)

  @@index([storeId])
}

model Activity {
  id        String       @id @default(uuid()) @db.Uuid
  storeId   String       @db.Uuid
  type      ActivityType
  notes     String?

  leadId     String? @db.Uuid
  customerId String? @db.Uuid
  vehicleId  String? @db.Uuid

  createdByUserId String? @db.Uuid @map("created_by_user_id")
  createdAt DateTime @default(now())

  store     Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  lead      Lead?     @relation(fields: [leadId], references: [id], onDelete: SetNull)
  customer  Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)
  vehicle   Vehicle?  @relation(fields: [vehicleId], references: [id], onDelete: SetNull)
  createdBy User?     @relation("ActivityCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  @@index([storeId])
  @@index([storeId, createdAt])
  @@index([leadId])
  @@index([customerId])
  @@index([vehicleId])
}

model VehicleSale {
  id        String   @id @default(uuid()) @db.Uuid
  storeId   String   @db.Uuid
  vehicleId String   @unique @db.Uuid

  soldByUserId String @db.Uuid @map("sold_by_user_id")
  customerId   String? @db.Uuid @map("customer_id")
  leadId       String? @db.Uuid @map("lead_id")

  soldAt     DateTime @default(now()) @map("sold_at")
  soldPrice  Decimal? @db.Decimal(12, 2) @map("sold_price")
  notes      String?

  store   Store   @relation(fields: [storeId], references: [id], onDelete: Cascade)
  vehicle Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  soldBy  User    @relation("VehicleSoldBy", fields: [soldByUserId], references: [id], onDelete: Restrict)

  customer Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)
  lead     Lead?     @relation(fields: [leadId], references: [id], onDelete: SetNull)

  @@index([storeId])
  @@index([storeId, soldByUserId])
  @@index([storeId, soldAt])
}

model Plan {
  id           String   @id @default(uuid()) @db.Uuid
  code         String   @unique
  name         String
  priceMonthly Decimal  @db.Decimal(12, 2) @map("price_monthly")
  currency     String   @default("USD")
  isActive     Boolean  @default(true)
  features     Json?
  createdAt    DateTime @default(now())

  subscriptions StoreSubscription[]

  @@index([isActive])
}

model StoreSubscription {
  id         String               @id @default(uuid()) @db.Uuid
  storeId    String               @db.Uuid
  planId     String               @db.Uuid
  provider   SubscriptionProvider
  status     SubscriptionStatus   @default(PENDING)

  startsAt   DateTime? @map("starts_at")
  endsAt     DateTime? @map("ends_at")

  approvedByUserId String? @db.Uuid @map("approved_by_user_id")
  approvedAt DateTime? @map("approved_at")

  canceledAt DateTime? @map("canceled_at")
  createdAt  DateTime @default(now())

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
  plan  Plan  @relation(fields: [planId], references: [id], onDelete: Restrict)

  approvedBy User? @relation("SubscriptionApprovedBy", fields: [approvedByUserId], references: [id], onDelete: SetNull)

  payments Payment[]

  @@index([storeId])
  @@index([storeId, status])
  @@index([storeId, endsAt])
}

model Payment {
  id                  String        @id @default(uuid()) @db.Uuid
  storeSubscriptionId String        @db.Uuid @map("store_subscription_id")
  provider            SubscriptionProvider
  status              PaymentStatus @default(PENDING)

  amount   Decimal @db.Decimal(12, 2)
  currency String  @default("USD")

  externalId String? @map("external_id")
  metadata   Json?

  paidAt    DateTime? @map("paid_at")
  createdAt DateTime  @default(now())

  subscription StoreSubscription @relation(fields: [storeSubscriptionId], references: [id], onDelete: Cascade)

  @@index([storeSubscriptionId])
  @@index([status])
  @@index([createdAt])
}

model AuditLog {
  id         String   @id @default(uuid()) @db.Uuid
  storeId    String   @db.Uuid
  actorUserId String? @db.Uuid @map("actor_user_id")

  action   String
  entity   String
  entityId String? @map("entity_id")

  ip        String?
  userAgent String? @map("user_agent")

  before    Json?
  after     Json?

  createdAt DateTime @default(now())

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
  actor User? @relation("AuditActor", fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([storeId])
  @@index([storeId, createdAt])
  @@index([actorUserId])
}

model Consignor {
  id        String   @id @default(uuid()) @db.Uuid
  storeId   String   @db.Uuid
  fullName  String   @map("full_name")
  email     String?
  phone     String?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  store     Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  vehicles  Vehicle[]

  @@index([storeId])
  @@index([storeId, createdAt])
}

model PermissionSet {
  id          String   @id @default(uuid()) @db.Uuid
  storeId     String   @db.Uuid
  name        String
  permissions Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  store       Store      @relation(fields: [storeId], references: [id], onDelete: Cascade)
  memberships UserRole[]

  @@unique([storeId, name])
  @@index([storeId])
}
